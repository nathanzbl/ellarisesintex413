<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participants | Ella Rises</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;500;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --pink: #FFD7D1;
            --blue: #A8C0CC;
            --text-gray: #4A4A4A;
            --purple-accent: #C4B7D3;
            --flower-red: #D9414E;
            --dark-text: #1f2937;
            --light-bg: #f7f7f7;
            --success-green: #4CAF50;
            --border-color: rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background-color: var(--light-bg); 
            font-family: 'Inter', 'Lato', sans-serif; 
            color: var(--dark-text); 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation (Copied from Landing Page) */
        nav {
            background-color: var(--pink);
            padding: 12px 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            border-bottom: 1px solid rgba(168, 192, 204, 0.3);
            position: sticky; top: 0; z-index: 50; width: 100%;
        }
        .nav-container { max-width: 72rem; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .nav-logo { height: 40px; }
        .nav-links { display: flex; gap: 32px; }
        .nav-links a { color: var(--dark-text); text-decoration: none; font-weight: 500; transition: color 0.3s ease; padding: 8px 0; }
        .nav-links a:hover { color: var(--flower-red); }
        .nav-links a.active { font-weight: 700; color: var(--flower-red); border-bottom: 2px solid var(--flower-red); }

        /* --- Custom Hero/Header Section --- */
        .hero-section {
            background-color: white; /* Clean background for crisp contrast */
            padding: 60px 20px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
        }
        .header-content-container { 
            max-width: 72rem; 
            margin: 0 auto; 
            display: flex;
            align-items: center;
            gap: 50px;
        }
        .hero-text {
            flex: 1;
        }
        .hero-text h1 { 
            font-size: 3rem; 
            font-weight: 700; 
            color: var(--dark-text); 
            font-family: 'Poppins', sans-serif; 
            margin-bottom: 15px;
        }
        .hero-text p { 
            font-size: 1.15rem; 
            color: var(--text-gray); 
            line-height: 1.6;
        }
        .hero-image-container {
            flex-shrink: 0;
            max-width: 450px; /* **Makes the image bigger** */
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .hero-image {
            width: 100%;
            height: auto;
            display: block;
        }
        /* --- END Hero Section --- */


        /* Dashboard Content */
        .dashboard-container { 
            max-width: 72rem; 
            margin: 40px auto 60px auto; 
            padding: 0 20px; 
            flex-grow: 1; 
        }

        .utility-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px; /* Increased margin */
            gap: 20px;
            background-color: white; 
            padding: 15px 20px; /* Added more padding */
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Crisp shadow */
        }
        .search-form {
            display: flex; flex-grow: 1; max-width: 400px;
        }
        .search-form input {
            padding: 12px 15px; /* Crisper padding */
            border: 1px solid #ccc; border-radius: 6px 0 0 6px; flex-grow: 1; font-size: 1rem;
        }
        .search-form button {
            background-color: var(--blue); color: var(--dark-text); padding: 12px 15px; 
            border: none; border-radius: 0 6px 6px 0; cursor: pointer; font-weight: 600; 
            transition: background-color 0.3s;
        }
        .search-form button:hover { background-color: #92b0c1; }

        .add-btn {
            background-color: var(--flower-red); color: white; padding: 12px 24px; /* Crisper padding */
            border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background-color 0.3s;
        }
        .add-btn:hover { background-color: #c4323c; }

        /* Table Styles */
        .data-table {
            width: 100%; border-collapse: collapse; background-color: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
            border-radius: 8px; overflow: hidden; font-size: 0.95rem;
        }
        .data-table th, .data-table td {
            padding: 15px; text-align: left; border-bottom: 1px solid var(--light-bg);
        }
        .data-table th {
            background-color: var(--purple-accent); color: white; font-weight: 600; text-transform: uppercase;
            cursor: pointer; /* Indicates sortable header */
            transition: background-color 0.2s;
        }
        .data-table th:hover { background-color: #a79cb7; }

        /* Sorting Icons */
        .data-table th span.sort-icon { margin-left: 8px; font-size: 0.8em; opacity: 0.6; }
        .data-table th[data-order="asc"] span.sort-icon { content: '‚ñ≤'; opacity: 1; }
        .data-table th[data-order="desc"] span.sort-icon { content: '‚ñº'; opacity: 1; }

        .data-table tr:nth-child(even) { background-color: #f9f9f9; }
        .data-table tr:hover { background-color: var(--pink); } 
        
        .action-btn { background: none; border: none; color: var(--dark-text); cursor: pointer; margin-right: 8px; font-size: 1.1rem; transition: color 0.2s; padding: 0; }
        .action-btn:hover { color: var(--flower-red); }
        .delete-btn:hover { color: #f44336; }
        .milestone-btn { color: var(--success-green); }

        footer { margin-top: auto; background-color: var(--blue); padding: 20px 20px; color: var(--dark-text); font-size: 0.9rem; text-align: center; }
        .error-message {
            color: var(--flower-red); background-color: var(--pink); padding: 15px; border-radius: 6px; 
            margin-bottom: 25px; border: 1px solid var(--flower-red); font-weight: 500;
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="/teapot">
                <img src="images/EllaRisesLogo.png.avif" alt="Ella Rises Logo" class="nav-logo">
            </a>
            <div class="nav-links">
                <a href="/donations">Donations</a>
                <a href="/events">Events</a>
                <a href="/milestones">Milestones</a>
                <a href="/participants" class="active">Participants</a>
                <a href="/surveys">Surveys</a>
                <a href="/logout">Log Out</a>
            </div>
        </div>
    </nav>

    <% 
        if (!user) { 
    %>
        <div style="text-align: center; padding: 100px;">
            <h2>Access Denied</h2>
            <p>Please log in to view participant data.</p>
            <a href="/login" class="cta-btn" style="display: inline-block; margin-top: 20px; background-color: var(--flower-red); color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none;">Go to Login</a>
        </div>
    <% } else { %>
        
        <div class="hero-section">
            <div class="header-content-container">
                <div class="hero-text">
                    <h1>Participant Management Dashboard</h1>
                    <p>Welcome, <%= user.name %>! This is your central hub for viewing and managing the young women in Ella Rises and tracking their progress, milestones, and enrollment status.</p>
                </div>
                <div class="hero-image-container">
                    <img src="images/ellarisesYouth.avif" alt="Group of diverse young women smiling" class="hero-image">
                </div>
            </div>
        </div>

        <div class="dashboard-container">
            <% if (locals.error_message) { %>
                <div class="error-message">
                    <%= locals.error_message %>
                </div>
            <% } %>

            <div class="utility-bar">
                <form action="/participants/search" method="GET" class="search-form">
                    <input type="text" name="query" placeholder="Search by name, program, or ID..." value="<%= locals.searchQuery || '' %>">
                    <button type="submit">Search</button>
                </form>

                <% if (user.isManager) { %>
                    <button class="add-btn" onclick="openAddParticipantModal()">
                        + Add New Participant
                    </button>
                <% } %>
            </div>

            <table class="data-table" id="participantsTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)" data-column="id">ID <span class="sort-icon"></span></th>
                        <th onclick="sortTable(1)" data-column="name">Name <span class="sort-icon"></span></th>
                        <th onclick="sortTable(2)" data-column="program">Program <span class="sort-icon"></span></th>
                        <th onclick="sortTable(3)" data-column="status">Status <span class="sort-icon"></span></th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <% 
                        for (let i = 0; i < locals.participants.length; i++) {
                            const participant = locals.participants[i];
                            const currentProgram = participant.currentProgram || 'Not Enrolled';
                    %>
                        <tr>
                            <td><%= participant.id %></td>
                            <td><%= participant.firstName %> <%= participant.lastName %></td>
                            <td><%= currentProgram %></td>
                            <td><%= participant.status %></td>
                            <td>
                                <button class="action-btn milestone-btn" title="Manage Milestones" onclick="openMilestoneModal(participant.id)">
                                    üåü Milestones
                                </button>
                                
                                <% if (user.isManager) { %>
                                    <button class="action-btn" title="Edit Participant" onclick="openEditParticipantModal(participant.id)">
                                        ‚úèÔ∏è
                                    </button>
                                    <button class="action-btn delete-btn" title="Delete Participant" onclick="confirmDelete(participant.id)">
                                        üóëÔ∏è
                                    </button>
                                <% } %>
                            </td>
                        </tr>
                    <% } %>
                    
                    <% if (locals.participants.length === 0) { %>
                        <tr>
                            <td colspan="5" style="text-align: center; color: var(--text-gray); padding: 30px;">
                                No participants found matching your criteria.
                            </td>
                        </tr>
                    <% } %>
                    
                </tbody>
            </table>
        </div>
        
    <% } %>
    
    <footer>
        <p>¬© 2025 Ella Rises. Empowering Futures.</p>
    </footer>

    <script>
        // --- CLIENT-SIDE TABLE SORTING FUNCTIONALITY ---
        function sortTable(n) {
            const table = document.getElementById("participantsTable");
            let rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            const headers = table.getElementsByTagName("TH");
            
            // Get the header element that was clicked
            const clickedHeader = headers[n];

            // Determine sorting direction
            let currentDir = clickedHeader.getAttribute("data-order") || "asc";
            dir = (currentDir === "asc") ? "desc" : "asc";

            // If a different column was clicked, reset all others to 'asc' and start sorting 'desc'
            if (clickedHeader.getAttribute("data-last-sorted") !== 'true') {
                for (i = 0; i < headers.length; i++) {
                    headers[i].removeAttribute("data-order");
                    headers[i].removeAttribute("data-last-sorted");
                    headers[i].querySelector('.sort-icon').textContent = '';
                }
                dir = "asc"; // Start new column sort in ASC order
                clickedHeader.setAttribute("data-last-sorted", 'true');
            }
            
            // Set the new direction
            clickedHeader.setAttribute("data-order", dir);
            clickedHeader.querySelector('.sort-icon').textContent = (dir === 'asc') ? '‚ñ≤' : '‚ñº';


            switching = true;
            while (switching) {
                switching = false;
                rows = table.rows;
                // Start from row 1 (skipping the header row)
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    // Get the two elements you want to compare, one from current row and one from the next
                    x = rows[i].getElementsByTagName("TD")[n];
                    y = rows[i + 1].getElementsByTagName("TD")[n];
                    
                    // Handle numeric vs string comparison
                    let xContent = x.innerHTML.toLowerCase().replace(/[^a-z0-9.]/g, "");
                    let yContent = y.innerHTML.toLowerCase().replace(/[^a-z0-9.]/g, "");

                    // Try converting to number for numeric columns (like ID)
                    let xVal = isNaN(parseFloat(xContent)) ? xContent : parseFloat(xContent);
                    let yVal = isNaN(parseFloat(yContent)) ? yContent : parseFloat(yContent);

                    // Check if rows should switch order
                    if (dir === "asc") {
                        if (xVal > yVal) {
                            shouldSwitch = true;
                            break;
                        }
                    } else if (dir === "desc") {
                        if (xVal < yVal) {
                            shouldSwitch = true;
                            break;
                        }
                    }
                }
                
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                    switchcount++;
                } else {
                    // If no switching has been done and the direction is 'desc', but we only sorted 'asc',
                    // then we want to mark the next click as 'desc' start. (Logic handled by header attribute update)
                    if (switchcount == 0 && currentDir == "asc") {
                        // This branch is largely handled by the attribute logic at the start.
                    }
                }
            }
        }
        
        // --- PLACEHOLDER FUNCTIONS ---

        function openAddParticipantModal() {
            console.log("Opening Add Participant Modal...");
        }

        function openEditParticipantModal(id) {
            console.log(`Opening Edit Participant Modal for ID: ${id}`);
        }

        function confirmDelete(id) {
            if (confirm(`Are you sure you want to delete participant ID ${id}? This action cannot be undone.`)) {
                console.log(`Deleting participant ID: ${id}`);
                // Implement AJAX POST request to delete participant here
            }
        }

        function openMilestoneModal(id) {
            window.location.href = `/milestones?participantId=${id}`;
        }
    </script>
</body>
</html>